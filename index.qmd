---
title: "ãƒ‘ãƒãƒ«ãƒ‡ãƒ¼ã‚¿ã§ã‚¢ãƒ¡ãƒªã‚«å¤§çµ±é ˜é¸ã‚’è§£æã™ã‚‹"
subtitle: "@higeme"
format: revealjs
---

```{r}
#| echo: false

library(conflicted)
library(tidyverse)
library(knitr)
library(broom)
library(kableExtra)
library(maps)
library(sf)
library(ggrepel)
library(plotly)
library(reshape2)
library(stargazer)
library(psych)
library(openxlsx)
library(psych)
conflicts_prefer(dplyr::filter)
conflicts_prefer(plotly::layout)
conflicts_prefer(purrr::map)

df <- read_csv("n_votes_usa_president_2012_2024.csv")
df_add <- df |> 
  pivot_wider() |> 
  mutate(rep_log = log(rep_votes)) |> 
  mutate(dem_log = log(dem_votes)) |> 
  mutate(total_log = log(total_votes)) |> 
  mutate(rep_rate = rep_votes / total_votes) |> 
  mutate(dem_rate = dem_votes / total_votes) |> 
  mutate(other_rate = 1 - rep_rate - dem_rate) |> 
  mutate(rep_rate_100 = rep_votes / (rep_votes + dem_votes)) |>
  mutate(dem_rate_100 = 1 - rep_rate_100) |> 
  pivot_longer(cols = c(-1, -2)) |> 
  arrange(year) |> 
  arrange(state)

piv <- summarise(.data = df, n = sum(value), .by = c(name, year)) |>
  pivot_wider(names_from = name, values_from = n) |>
  arrange(year)

piv_rate <- piv |> 
  mutate(rep_rate = rep_votes / total_votes) |> 
  mutate(dem_rate = dem_votes / total_votes) |> 
  mutate(other_rate = 1 - rep_rate - dem_rate) |> 
  select(year, rep_rate, dem_rate, other_rate) |> 
  mutate(across(c(rep_rate, dem_rate, other_rate), ~ round(.x, digits = 3)))

piv_rate_100 <- piv |> 
  mutate(rep_rate = rep_votes / (rep_votes + dem_votes)) |> 
  mutate(dem_rate = dem_votes / (rep_votes + dem_votes)) |> 
  select(year, rep_rate, dem_rate) |> 
  mutate(across(c(rep_rate, dem_rate), ~ round(.x, digits = 3)))

df_dif_rate <- df |> 
  pivot_wider() |> 
  mutate(dif = round(((rep_votes - dem_votes) / total_votes) * 100, digits = 1))
```

## è‡ªå·±ç´¹ä»‹
- æ—©ç¨²ç”°å¤§å­¦ç¬¬ä¸€æ–‡å­¦éƒ¨æ¼”åŠ‡å°‚ä¿®å’æ¥­ï¼ˆå½“æ™‚æ‰€æ²¢å¸‚å±±å£åœ¨ä½ï¼‰

- ä½ä¹…é•·è–ä¸­å­¦ãƒ»é«˜ç­‰å­¦æ ¡ï¼ˆå›½èªç§‘æ•™è«­ï¼‰

- ç—…é™¢ã«è»¢è·ã€‚ãã®å¾ŒåŒ»ç™‚é–¢ä¿‚ã®è·ã‚’è»¢ã€…ã¨ã™ã‚‹ã€‚

- åŒ»ç™‚æ³•äººä¸¸å±±ä¼šã€€ä¸¸å­ä¸­å¤®ç—…é™¢ã€€çµŒå–¶ä¼ç”»èª²

- å›½ç«‹å¤§å­¦æ³•äººä¿¡å·å¤§å­¦å¤§å­¦é™¢çµŒæ¸ˆå­¦åˆ†é‡ä¿®äº†

- ä¿¡å·æœ¨æ›½çœ‹è­·å°‚é–€å­¦æ ¡éå¸¸å‹¤è¬›å¸«ï¼ˆçœ‹è­·ç ”ç©¶ã€€çµ±è¨ˆå­¦ï¼‰

- ï¼ˆè³‡æ ¼ï¼‰çµ±è¨ˆæ¤œå®šï¼’ç´šå–å¾—ã€æº–1ç´šå‹‰å¼·ä¸­ã€‚JDLA Deep Learning for GENERAL 2023 #1

## Arizona

![Arizona](arizona.png)

## Stadium Locations in the United States
```{r}
stadiums <- read_csv("stadiums.csv")

# MLB, NFL, NBAã®ãƒ‡ãƒ¼ã‚¿ã®ã¿æŠ½å‡º
selected_leagues <- c("MLB", "NFL", "NBA")
sports_data <- stadiums %>%
  filter(League %in% selected_leagues) %>%
  rename(lon = Long, lat = Lat, league = League, team = Team) %>%
  select(team, league, lon, lat)

# sfã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
sports_sf <- st_as_sf(sports_data, coords = c("lon", "lat"), crs = 4326)

# ã‚¢ãƒ¡ãƒªã‚«åœ°å›³ãƒ‡ãƒ¼ã‚¿
usa <- st_as_sf(maps::map("state", plot = FALSE, fill = TRUE))

# å…¨ä½“åœ°å›³ã®ä½œæˆ
full_map <- ggplot() +
  geom_sf(data = usa, fill = "lightgray", color = "white") +
  geom_sf(data = sports_sf, aes(color = league), size = 2.5, shape = 16) +
  geom_label_repel(data = sports_data, aes(x = lon, y = lat, label = team, color = league),
                   size = 2.5, box.padding = 0.5, max.overlaps = 10, force = 5) +
  scale_color_manual(values = c("MLB" = "red", "NFL" = "blue", "NBA" = "green")) +
  labs(
    title = "MLB, NFL, and NBA Stadium Locations in the United States",
    subtitle = "Locations of Major Sports League Stadiums with Team Names",
    color = "League",
    caption = "Data Source: Kaggle - Sports Stadium Locations"
  ) +
  theme_minimal() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), panel.grid = element_blank())

full_map
```

## Rè¨€èªAdvent Calendar 2024ã€€21æ—¥ç›®

[https://qiita.com/hige_megane/items/062fcf108b1cd8ba056d](https://qiita.com/hige_megane/items/062fcf108b1cd8ba056d)


ã€Œå¤šãã®äººãŒå…±å’Œå…šåœ§å‹ã ã£ãŸã¨ã„ã†ãŒã€æœ¬å½“ã¯åƒ…å·®ã ã£ãŸã€ã¯æœ¬å½“ã«ãã†ã‹è‡ªåˆ†ã§è¦–è¦šåŒ–ã—ãŸããªã‚Šã¾ã—ãŸã€‚ãã“ã§ã€å¹´æœ«å¹´å§‹ã€ã—ã“ã—ã“ã¨Rã§ãƒ—ãƒ­ã‚°ãƒ©ãƒ çµ„ã‚“ã§ã¿ã¾ã—ãŸã€‚ç§ã®ã‚ˆã†ãªåˆå¿ƒè€…ãŒåœ°å›³ã«é¸æŒ™ã®å‹æ•—å…·åˆã‚’è‰²åˆ†ã‘ã™ã‚‹ãªã‚“ã¦ã€ç”ŸæˆAIã®ãªã„æ™‚ä»£ãªã‚‰è€ƒãˆã‚‰ã‚Œãªã„ã“ã¨ã§ã€chatGPTãŒå‡ºã¦ã‚ãšã‹2å¹´ä½™ã‚Šãªã®ã«éš”ä¸–ã®æ„ŸãŒã‚ã‚Šã¾ã™ã­ã€‚

## USAã®åœ°å›³ã«å¾—ç¥¨ç‡ã‚’å¡—ã‚Šåˆ†ã‘ã‚‹Rã‚³ãƒ¼ãƒ‰

```{r}
#| echo: true

# ã‚¢ãƒ¡ãƒªã‚«ã®å·å¢ƒç•Œãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
states_map <- st_as_sf(maps::map("state", plot = FALSE, fill = TRUE)) |> 
  mutate(state = ID)
valid_states <- states_map$state

#alaskaã¨hawaiiã®2å·ãŒé™¤å¤–ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
df_deleted <- filter(.data = df_dif_rate, !state %in% valid_states)
#2å·ã‚’å‰Šé™¤ã—ãŸãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
df_49 <- filter(.data = df_dif_rate, state %in% valid_states)
#49å·ã®ç·¯åº¦çµŒåº¦å¢ƒç•Œãƒ‡ãƒ¼ã‚¿ã‚’left_join()ã§è¿½åŠ 
df_n_percent <- left_join(states_map, df_49, by = "state")

#å¡—åˆ†ã‘æ¯”ç‡ã‚’å›ºå®š
dif_range <- range(df_n_percent$dif)

df_2012 <- filter(.data = df_n_percent, year == 2012)
us_map_plot_2012 <- ggplot(data = df_2012) +
  geom_sf(aes(fill = dif), color = "black", size = 0.2) +  # difã§å¡—ã‚Šåˆ†ã‘
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0, 
                       name = "share values",
                       limits = dif_range) +             # ã‚«ãƒ©ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«
  geom_sf_text(aes(label = ID), 
               size = 2, color = "black") +
  theme_minimal() +                                     # ãƒ†ãƒ¼ãƒã‚’èª¿æ•´
  theme(legend.position = "bottom")

df_2016 <- filter(.data = df_n_percent, year == 2016)
us_map_plot_2016 <- ggplot(data = df_2016) +
  geom_sf(aes(fill = dif), color = "black", size = 0.2) +  # difã§å¡—ã‚Šåˆ†ã‘
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0, 
                       name = "share values",
                       limits = dif_range) +             # ã‚«ãƒ©ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«
  geom_sf_text(aes(label = ID), 
               size = 2, color = "black") +
  theme_minimal() +                                     # ãƒ†ãƒ¼ãƒã‚’èª¿æ•´
  theme(legend.position = "bottom")

df_2020 <- filter(.data = df_n_percent, year == 2020)
us_map_plot_2020 <- ggplot(data = df_2020) +
  geom_sf(aes(fill = dif), color = "black", size = 0.2) +  # difã§å¡—ã‚Šåˆ†ã‘
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0, 
                       name = "share values",
                       limits = dif_range) +             # ã‚«ãƒ©ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«
  geom_sf_text(aes(label = ID), 
               size = 2, color = "black") +
  theme_minimal() +                                     # ãƒ†ãƒ¼ãƒã‚’èª¿æ•´
  theme(legend.position = "bottom")

df_2024 <- filter(.data = df_n_percent, year == 2024)
us_map_plot_2024 <- ggplot(data = df_2024) +
  geom_sf(aes(fill = dif), color = "black", size = 0.2) +  # difã§å¡—ã‚Šåˆ†ã‘
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0, 
                       name = "share values",
                       limits = dif_range) +             # ã‚«ãƒ©ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«
  geom_sf_text(aes(label = ID), 
               size = 2, color = "black") +
  theme_minimal() +                                     # ãƒ†ãƒ¼ãƒã‚’èª¿æ•´
  theme(legend.position = "bottom")
```

## 2012å¹´ã®é¸æŒ™çµæœ
```{r}
plot(us_map_plot_2012)
```

## 2016å¹´ã®é¸æŒ™çµæœ
```{r}
plot(us_map_plot_2016)
```

## 2020å¹´ã®é¸æŒ™çµæœ
```{r}
plot(us_map_plot_2020)
```

## 2024å¹´ã®é¸æŒ™çµæœ
```{r}
plot(us_map_plot_2024)
```

## ç§ã¯ãªãœRã‚’ä½¿ã†ã®ã‹

Rã«æ„›ç€ãŒã‚ã‚‹ã‹ã‚‰ã§ã™ï¼ãŒâ€¦

## ä½•ã‹Rã«å¯¾ã™ã‚‹å”¯ã¼ã‚“ã‚„ã‚Šã¨ã—ãŸä¸å®‰

- ç”ŸæˆAIã«å°‹ã­ã‚‹ã¨æ—¥æœ¬åœ°å›³ã‚’å¡—ã‚Šåˆ†ã‘ã‚‹ãŸã‚ã®libraryã¯ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ãŒã€cranã«ç™»éŒ²ã•ã‚Œã¦ã„ãªã„ï¼Ÿ.shpãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨æ„ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŒã€é©åˆ‡ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒæ¡ˆå¤–é›£ã—ã„ã€‚
- utf-8ï¼ˆã®ã¿ï¼‰ãŒå¾—æ„ãªRã‚’æ—¥æœ¬ã§ä½¿ã†ãƒ¡ãƒªãƒƒãƒˆã¯ï¼Ÿ

# Rã‚’ä½¿ã†æ„ç¾©ã¯ã€Œãƒ‡ãƒ¼ã‚¿è§£æã€ã«ã‚ã‚Šï¼

## ã‚¢ãƒ¡ãƒªã‚«å¤§çµ±é ˜é¸æŒ™ã®æŠ•ç¥¨çµæœãƒ‡ãƒ¼ã‚¿

2012å¹´ã€2016å¹´ã€2020å¹´ã€2024å¹´ã®å¤§çµ±é ˜é¸4å›åˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’[Wikipedia](https://en.wikipedia.org/wiki/2024_United_States_presidential_election)ã‚ˆã‚Šå–å¾—ã€‚

2024å¹´é¸æŒ™ã¯ä¸‹è¨˜ãŒæœ€çµ‚çµæœã¨æ€ã‚ã‚Œã‚‹ã€‚

"2024 Presidential Election Results". Associated Press. January 2, 2025. Retrieved January 2, 2025.

## ãƒ‡ãƒ¼ã‚¿ã®æ¦‚è¦

51å·(District of Columbiaå«ã‚€) X

å…±å’Œå…šå¾—ç¥¨æ•°ã€æ°‘ä¸»å…šå¾—ç¥¨æ•°ã€ç·å¾—ç¥¨æ•° X

2012ï½2024å¹´ã®ã‚¢ãƒ¡ãƒªã‚«å¤§çµ±é ˜é¸4å›ã€‚

```{r}
#| echo: false
# ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã®è¡Œæ•°ã¨åˆ—æ•°ã‚’å–å¾—
n_rows <- nrow(df)
n_cols <- ncol(df)
head_rows <- 6

# ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã«ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã®ã‚µã‚¤ã‚ºæƒ…å ±ã‚’å«ã‚ã‚‹
caption_text <- sprintf("å…¨%dè¡Œ x %dåˆ—", n_rows, n_cols)

df |> 
  head(head_rows) |> 
  kable("html", caption = caption_text) |> 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) |> 
  row_spec(0, background = "#CCCCCC", color = "black", bold = TRUE) |> 
  column_spec(1, bold = TRUE)
```

## **ã‚¢ãƒ¡ãƒªã‚«å…¨å·ã®æŠ•ç¥¨çµæœ**

```{r}
#| echo: false
kable(piv, format = "html" #, caption="ãƒ”ãƒœãƒƒãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã®çµæœ"
      ) %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

## å…¨æŠ•ç¥¨æ•°ã«å ã‚ã‚‹å¾—ç¥¨ç‡

```{r}
#| echo: false
kable(piv_rate, format = "html" #, caption="ãƒ”ãƒœãƒƒãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã®çµæœ"
      ) %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

## ä¸»è¦2å…šã®æŠ•ç¥¨åˆè¨ˆã‚’1ã¨ã—ãŸã¨ãã®å¾—ç¥¨ç‡

```{r}
#| echo: false
kable(piv_rate_100, format = "html" #, caption="ãƒ”ãƒœãƒƒãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã®çµæœ"
      ) %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

# æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ã¯ãƒ‘ãƒãƒ«ãƒ‡ãƒ¼ã‚¿ã«ã™ã‚‹ã“ã¨ã‚’è€ƒãˆã‚ˆã†ï¼

## ãƒ‘ãƒãƒ«ãƒ‡ãƒ¼ã‚¿ã®ãƒ¡ãƒªãƒƒãƒˆ

- å˜ç´”ãªæ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ï¼ˆ1ã¤ã®å¯¾è±¡ã‚’æ™‚ç³»åˆ—ã§è¦‹ã‚‹ï¼‰ã‚„æ¨ªæ–­ãƒ‡ãƒ¼ã‚¿ï¼ˆè¤‡æ•°å¯¾è±¡ã‚’ã‚ã‚‹æ™‚ç‚¹ã§è¦‹ã‚‹ï¼‰ã¨æ¯”è¼ƒã—ã¦ã€ãƒ‘ãƒãƒ«ãƒ‡ãƒ¼ã‚¿ã¯ã€Œæ¨ªæ–­é¢ Ã— æ™‚ç³»åˆ—ã€ã®ä¸¡æ–¹ã®æƒ…å ±ã‚’å«ã‚€ãŸã‚ã€ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚ºãŒå¢—ãˆã€æ¨å®šç²¾åº¦å‘ä¸ŠãŒæœŸå¾…ã§ãã‚‹ã€‚

- å„å€‹ä½“å›ºæœ‰ã®ï¼ˆã—ã‹ã—è¦³æ¸¬ã§ããªã„ï¼‰ç‰¹æ€§ã‚’ãƒ¢ãƒ‡ãƒ«ã§æ‰±ã„ã‚„ã™ããªã‚‹ã€‚

## ãƒ‘ãƒãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ã®æ¨å®šæ–¹æ³•

1. pooling

2. within

3. random


## ãƒ‘ãƒãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ã®æ¨å®šæ–¹æ³•1

1. poolingï¼ˆå˜ç´”ãªå›å¸°åˆ†æï¼‰

- ç¸¦æ–­é¢ï¼ˆå€‹ä½“ï¼‰ã®é•ã„ã‚‚æ™‚é–“çš„ãªé•ã„ã‚‚å…¨ãè€ƒæ…®ã›ãšã€å˜ç´”ã«ã€Œå…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬ã«ã€ã¾ã¨ã‚ã¦ï¼ˆãƒ—ãƒ¼ãƒ«ã—ã¦ï¼‰å›å¸°ã‚’è¡Œã†æ–¹æ³•ã€‚

- ãƒ‘ãƒãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ãŸã ã®ã€Œå¤§ããªæ¨ªæ–­ãƒ‡ãƒ¼ã‚¿ã€ã‚ã‚‹ã„ã¯ã€Œå¤§ããªæ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ã€ã®ã‚ˆã†ã«æ‰±ã†ã€‚

## ãƒ‘ãƒãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ã®æ¨å®šæ–¹æ³•2

2. withinï¼ˆå›ºå®šåŠ¹æœãƒ¢ãƒ‡ãƒ«ã€FEMï¼‰

- å„å€‹ä½“ï¼ˆä»Šå›ã¯å·ï¼‰ãŒæŒã¤ã€Œè¦³æ¸¬ã•ã‚Œãªã„ãŒæ™‚é–“ã‚’é€šã˜ã¦ä¸å¤‰ãªç‰¹æ€§ã€ã‚’å›ºå®šåŠ¹æœã¨ã¿ãªã—ã€ãã‚Œã‚’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã™ã‚‹ã€‚

- å€‹ä½“ã”ã¨ã«ç•°ãªã‚‹ã€Œä¸å¤‰ã®ç‰¹æ€§ã€ã‚’å–ã‚Šé™¤ããŸã‚ã€è¦³æ¸¬ã•ã‚Œãªã„è¦å› ã«ã‚ˆã‚‹ãƒã‚¤ã‚¢ã‚¹ã‚’å¤§ããæ¸›ã‚‰ã›ã‚‹ã€‚

- èª¬æ˜å¤‰æ•°ã¨å€‹ä½“åŠ¹æœãŒç›¸é–¢ã—ã¦ã„ã¦ã‚‚å¤§ä¸ˆå¤«ã ãŒã€æ™‚é–“ä¸å¤‰ã®å¤‰æ•°ãŒæ¨å®šã§ããªã„ã€‚

## ãƒ‘ãƒãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ã®æ¨å®šæ–¹æ³•3

3. random(å¤‰é‡åŠ¹æœãƒ¢ãƒ‡ãƒ«ã€REM)

- å€‹ä½“ã”ã¨ã®ç‰¹æ€§ï¼ˆå€‹ä½“åŠ¹æœï¼‰ã‚’ã€Œç¢ºç‡çš„ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ï¼‰ãªã‚‚ã®ã€ã¨ã¿ãªã—ã€èª¤å·®é …ã®ä¸€éƒ¨ã¨ã—ã¦æ‰±ã†ã€‚

- èª¬æ˜å¤‰æ•°ã¨ã®ç„¡ç›¸é–¢ã‚’ä»®å®šã™ã‚‹ãŸã‚ã€ãã®ä»®å®šãŒæº€ãŸã•ã‚Œã‚Œã°åŠ¹ç‡çš„ã€æº€ãŸã•ã‚Œãªã‘ã‚Œã°ãƒã‚¤ã‚¢ã‚¹ãŒç”Ÿã˜ã‚‹ã€‚

â†’Hausmanæ¤œå®š

## å›ºå®šåŠ¹æœãƒ¢ãƒ‡ãƒ«ã¨å¤‰é‡åŠ¹æœãƒ¢ãƒ‡ãƒ«ã®æ•°å¼

å€‹ä½“ï¼ˆä»Šå›ã®å ´åˆã¯å·ï¼‰ã®index$: i = 1, 2, \dots , N$

æ™‚ç‚¹ã®index$:t = 1, 2, \dots , T$

è¢«èª¬æ˜å¤‰æ•°$:y_{it}$
 
èª¬æ˜å¤‰æ•°ãƒ™ã‚¯ãƒˆãƒ«$:x_{it}$ï¼ˆ$ğ‘˜$æ¬¡å…ƒï¼‰

èª¤å·®é …ï¼š$u_{it}$

## å›ºå®šåŠ¹æœãƒ¢ãƒ‡ãƒ«ï¼ˆFixed Effects Modelï¼‰

å€‹ä½“ã”ã¨ã®åŠ¹æœ$\alpha_i$ã‚’è¦³æ¸¬ä¸å¯èƒ½ã ãŒå›ºå®šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦æ¨å®šã™ã‚‹ã€‚

$y_{it} = \alpha_i + x_{it} \beta + u_{it}$

å„å€‹ä½“$i$ã«ã¤ã„ã¦æ™‚é–“å¹³å‡ã‚’å¼•ãã“ã¨ã§$\alpha_i$ã‚’æ¶ˆå»ã™ã‚‹ã€‚

$y_{it} - \bar{y_i} = (\alpha_i - \alpha_i) + (x_{it}- \bar{x_i}) \beta + (u_{it} - \bar{u_i})$

å€‹ä½“ä¸å¤‰ã®è¦å› ã‚’é™¤å»ã®ä¸Šé€šå¸¸ã®OLSã‚’é©ç”¨ã™ã‚Œã°$\beta$ã®æ¨å®šãŒå¯èƒ½ã€‚

##  å¤‰é‡åŠ¹æœãƒ¢ãƒ‡ãƒ«(Random Effects Model)

å€‹ä½“ã”ã¨ã®åŠ¹æœã‚’ãƒ©ãƒ³ãƒ€ãƒ ãªç¢ºç‡å¤‰æ•°$\mu_i$ã§æ‰±ã†ã€‚

$y_{it} = \alpha + x_{it} \beta + \mu_i + u_{it} \quad | \quad Cov(\mu_i, x_{it}) = 0$

åˆæˆèª¤å·®é … $\epsilon_{it} = \mu_i + u_{it}$ ã§èª¤å·®é …ã‚’è€ƒãˆã‚‹ãŒã€$\mu_i$ã¨$u_{it}$ã¯æ™‚ç‚¹é–“ã§ç›¸é–¢ãŒç”Ÿã˜ã‚‹ãŸã‚ã€OLSã§ã¯ãªãGLSï¼ˆä¸€èˆ¬åŒ–æœ€å°äºŒä¹—æ³•ï¼‰ã‚’ç”¨ã„ã¦èª¤å·®æ§‹é€ ã‚’è€ƒæ…®ã—ã¤ã¤$\beta$ã‚’æ¨å®šã™ã‚‹ã€‚

$\mu_i$ãŒãƒ©ãƒ³ãƒ€ãƒ ã®ãŸã‚ã€$\beta$ã¨åˆ†æ•£ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿$\sigma_\mu^2, \sigma_u^2$ãªã©ã‚’æ¨å®šã™ã‚‹ã ã‘ã§ã™ã‚€ã€‚


## ãƒ‘ãƒãƒ«ãƒ‡ãƒ¼ã‚¿ã®ä½œã‚Šæ–¹
```{r}
#| echo: true
df_dif_rate_2 <- df_add |> 
  mutate(fy2012 = if_else(year == 2012, 1, 0)) |> 
  mutate(fy2016 = if_else(year == 2016, 1, 0)) |> 
  mutate(fy2020 = if_else(year == 2020, 1, 0))
df_rep_100 <- df_dif_rate_2 |> 
  filter(name == "rep_rate_100")
library(plm)
plm_rep_100 <- pdata.frame(df_rep_100, index = c("state", "year"))
head(plm_rep_100, n = 12)
```

## å›å¸°åˆ†æå¼

$n = \beta_0 + \beta_1 * fy12 + \beta_2 * fy16 + \beta_3 * fy20$

å„å¹´ã®å€¤

$n_{(fy12)} = \beta_0 + \beta_1 * fy12$

$n_{(fy16)} = \beta_0 + \beta_2 * fy16$

$n_{(fy20)} = \beta_0 + \beta_3 * fy20$

$n_{(fy24)} = \beta_0$

## ã‚³ãƒ¼ãƒ‰ã¨çµæœ(ç›®çš„å¤‰æ•°:rep+dem=1ã¨ã—ãŸã¨ãã®rep_rate)
```{r}
#| echo: true
pooling_2024 <- plm(value ~ fy2012 + fy2016 + fy2020,
                    data = plm_rep_100, model = "pooling")
within_2024 <- plm(value ~ fy2012 + fy2016 + fy2020,
                   data = plm_rep_100, model = "within")
random_2024 <- plm(value ~ fy2012 + fy2016 + fy2020,
                   data = plm_rep_100, model = "random")
stargazer(pooling_2024, within_2024, random_2024, type = "text")
```

## F test

å€‹ä½“åŠ¹æœã®æœ‰ç„¡ã‚’æ¤œå®šã€‚

$H_0:$ å€‹ä½“åŠ¹æœãŒå­˜åœ¨ã—ãªã„ã€‚â†’pooling

$H_1:$ å€‹ä½“åŠ¹æœãŒå­˜åœ¨ã™ã‚‹ã€‚â†’within

```{r}
#| echo: true
pFtest(within_2024, pooling_2024) 
```

## Hausman test

å€‹ä½“åŠ¹æœã¨èª¬æ˜å¤‰æ•°ã«ç›¸é–¢ãŒã‚ã‚‹ã‹ã®æ¤œå®šã€‚

$H_0:$ ãƒ©ãƒ³ãƒ€ãƒ åŠ¹æœãƒ¢ãƒ‡ãƒ«ã¯ä¸åã‹ã¤åŠ¹ç‡çš„ã€‚â†’random

$H_1:$ å€‹ä½“åŠ¹æœã¨èª¬æ˜å¤‰æ•°ã«ç›¸é–¢ãŒã‚ã‚‹ã€‚â†’within

```{r}
#| echo: true
phtest(within_2024, random_2024)
```

## å¤šå¤‰é‡è§£æã®ã ã„ã”å‘³ã¯ã„ã‚ã„ã‚ãªæŒ‡æ¨™ã‚’ã„ã‚Œã‚‹ã“ã¨ã«ã‚ã‚Š

"Census"[https://data.census.gov/](https://data.census.gov/)ã«ã‚¢ãƒ¡ãƒªã‚«åˆè¡†å›½ã®å„å·ã®æƒ…å ±ãŒæ²è¼‰ã•ã‚Œã¦ã„ã‚‹ã€‚

- äººå£ï¼ˆ18æ­³ä»¥ä¸Šäººå£ï¼‰
- ç”·å¥³æ¯”
- å¹´é½¢ä¸­å¤®å€¤
- ç™½äººæ¯”ç‡
- é»’äººæ¯”ç‡
- å€‹äººæ‰€å¾—

```{r}
# ç›¸é–¢ä¿‚æ•°ã®ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—
#USA state database
#https://apps.bea.gov/itable/?ReqID=99&step=1&_gl=1*17sn41j*_ga*MjAxMjU2MzA3Ny4xNzE3NjcyODY5*_ga_J4698JNNFT*MTcxNzY3Mjg3OS4xLjEuMTcxNzY3Mjg5OS40MC4wLjA.#eyJhcHBpZCI6OTksInN0ZXBzIjpbMSwyOSwyNSwyNl0sImRhdGEiOltbIlRhYmxlSWQiLCI2MDAiXSxbIk1ham9yQXJlYUtleSIsIjAiXV19
#SASUMMARY State annual summary statistics: personal income, GDP, consumer spending, price indexes, and employment
#Real personal income (Millions of constant 2017 dollars)
df_income <- read_csv("personal_income.csv", skip = 3) |> 
  rename(name = GeoName,
         personal_income_2023 = "2023") |> 
  filter(!is.na(name)) |> 
  mutate(personal_income_2023 = as.integer(personal_income_2023)) |> 
  filter(GeoFips != "00000") |> 
  select(-GeoFips)

#https://data.census.gov/table/ACSST1Y2023.S0101?q=sex&g=010XX00US$0400000&moe=false
target_label <- dplyr::tibble(
  label = c("Total population", "18 years and over", "Median age (years)", "Sex ratio (males per 100 females)"),
  new_label = c("total_population", "over_18years_old", "median_age", "males_per_100_females"))
df_pop_sex <- read_csv("ACSST1Y2023.S0101-2025-01-12T021909.csv") |> 
  rename(label = 1) |> 
  mutate(label = str_squish(label)) |> 
  pivot_longer(cols = -1) |> 
  filter(str_detect(name, "Total!!Estimate")) |> 
  mutate(value = as.numeric(str_replace_all(value, ",", ""))) |> 
  filter(!is.na(value)) |> 
  mutate(name = str_sub(name, 1, -18)) |>
  filter(name != "Puerto Rico") |> 
  filter(label %in% target_label$label) |> 
  left_join(target_label, by = "label") |> 
  select(-label) |> 
  rename(label = new_label) |> 
  pivot_wider(names_from = label, values_from = value)

#https://data.census.gov/table/DECENNIALCD1182020.P8?q=white&g=010XX00US$0400000
df_race <- read_csv("DECENNIALCD1182020.P8-2025-01-12T074840.csv") |> 
  slice(1, 3, 4) |> 
  rename(label = 1) |> 
  mutate(label = str_squish(label)) |> 
  pivot_longer(cols = -1) |> 
  mutate(label = str_sub(label, 1, 5)) |> 
  pivot_wider(names_from = label, values_from = value) |>
  filter(name != "Puerto Rico") |> 
  mutate(white_rate = White / Total,
         black_rate = Black / Total) |> 
  select(name, white_rate, black_rate)

df_database <- left_join(df_pop_sex, df_race, by = "name") |> 
  left_join(df_income, by = "name") |> 
  mutate(personal_income = personal_income_2023 * 1000000 / total_population) |> 
  select(-personal_income_2023, -total_population) |> 
  mutate(name = str_to_lower(name)) |> 
  rename(state = name)

numeric_data <- select(.data = df_database, -state)
cor_matrix <- cor(numeric_data)

melted_cor <- melt(cor_matrix)

# Create an interactive heatmap
p <- plot_ly(
  x = melted_cor$Var1,
  y = melted_cor$Var2,
  z = melted_cor$value,
  type = "heatmap",
  colorscale = "RdBu",  # Red-Blue diverging colorscale
  zmin = -1,            # Set minimum correlation value
  zmax = 1             # Set maximum correlation value
) %>%
  layout(
    title = "Correlation Matrix Heatmap",
    xaxis = list(title = ""),
    yaxis = list(title = ""),
    annotations = list(
      x = melted_cor$Var1,
      y = melted_cor$Var2,
      text = round(melted_cor$value, 2),  # Show correlation values rounded to 2 decimals
      showarrow = FALSE,
      font = list(color = 'white')
    )
  )
df_database_long <- df_database |> 
  mutate(across(c(white_rate, black_rate), ~ . * 100)) |> 
  pivot_longer(cols = -1) |> 
  summarise(ave = mean(value),
            sd = sd(value),
            med = median(value),
            max = max(value),
            min = min(value),
             .by = "name") |> 
  mutate(across(c(ave:min), ~ round(.)))
```

## è¨˜è¿°çµ±è¨ˆ

```{r}
#| echo: false
kable(df_database_long, format = "html" #, caption="ãƒ”ãƒœãƒƒãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã®çµæœ"
      ) %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

## Heat Map
```{r}
# | echo: true
p
```

## é»’äººæ¯”ç‡ãŒé«˜ã„ã¨å¥³æ€§ãŒå¤šã„ï¼Ÿ
1. Differential Mortality Rates

Black men in the United States experience higher mortality rates from many causes (e.g., heart disease, homicide)

2. Incarceration Rates

Black men are incarcerated at disproportionately higher rates. When incarcerated, they are not counted among the â€œfreeâ€ resident population

3. Migration and Labor Patterns

In some regions, younger Black men may leave rural Southern states in search of work or opportunities elsewhere.

```{r}
#| echo: false
df_dif_all <- df_dif_rate_2 |> 
  left_join(df_database, by = "state")
target_variable <- distinct(.data = df_dif_all, name, .keep_all = FALSE)$name
```

## ãƒ‘ãƒãƒ«ãƒ‡ãƒ¼ã‚¿åŒ–Rã‚³ãƒ¼ãƒ‰
```{r}
#| echo: true
df_plm_total_log <- df_dif_all |> 
  filter(name == "total_log") |> 
  pdata.frame(index = c("state", "name"), drop.index = FALSE)
pooling_total_log <- plm(value ~ median_age + males_per_100_females + white_rate +
               personal_income + fy2012 + fy2016 + fy2020, data = df_plm_total_log,
               model = "pooling")
within_total_log <- plm(value ~ median_age + males_per_100_females + white_rate +
               personal_income + fy2012 + fy2016 + fy2020, data = df_plm_total_log,
               model = "within")
random_total_log <- plm(value ~ median_age + males_per_100_females + white_rate +
               personal_income + fy2012 + fy2016 + fy2020, data = df_plm_total_log,
               model = "random")
```

## pFtest, phtest

```{r}
#| echo: true
pFtest(within_total_log, pooling_total_log)
phtest(within_total_log, random_total_log)
```

## æŠ•ç¥¨ç·æ•°ã®è‡ªç„¶å¯¾æ•°ã‚’ç›®çš„å¤‰æ•°ã¨ã—ãŸå›å¸°åˆ†æ(random)
```{r}
#| echo: true
summary(random_total_log)
```

## cf.æŠ•ç¥¨ç·æ•°ã®è‡ªç„¶å¯¾æ•°ã‚’ç›®çš„å¤‰æ•°ã¨ã—ãŸå›å¸°åˆ†æ(within)
```{r}
#| echo: true
summary(within_total_log)
```

```{r}
#| echo: false
df_plm_rep_rate_100 <- df_dif_all |> 
  filter(name == "rep_rate_100") |> 
  pdata.frame(index = c("state", "name"), drop.index = FALSE)
pooling_rep_rate_100 <- plm(value ~ median_age + males_per_100_females + white_rate +
               personal_income + fy2012 + fy2016 + fy2020, data = df_plm_rep_rate_100,
               model = "pooling")
within_rep_rate_100 <- plm(value ~ median_age + males_per_100_females + white_rate +
               personal_income + fy2012 + fy2016 + fy2020, data = df_plm_rep_rate_100,
               model = "within")
random_rep_rate_100 <- plm(value ~ median_age + males_per_100_females + white_rate +
               personal_income + fy2012 + fy2016 + fy2020, data = df_plm_rep_rate_100,
               model = "random")
pFtest(within_rep_rate_100, pooling_rep_rate_100)
phtest(within_rep_rate_100, random_rep_rate_100)

df_plm_rep_log <- df_dif_all |> 
  filter(name == "rep_log") |> 
  pdata.frame(index = c("state", "name"), drop.index = FALSE)
pooling_rep_log <- plm(value ~ median_age + males_per_100_females + white_rate +
               personal_income + fy2012 + fy2016 + fy2020, data = df_plm_rep_log,
               model = "pooling")
within_rep_log <- plm(value ~ median_age + males_per_100_females + white_rate +
               personal_income + fy2012 + fy2016 + fy2020, data = df_plm_rep_log,
               model = "within")
random_rep_log <- plm(value ~ median_age + males_per_100_females + white_rate +
               personal_income + fy2012 + fy2016 + fy2020, data = df_plm_rep_log,
               model = "random")
pFtest(within_rep_log, pooling_rep_log)
phtest(within_rep_log, random_rep_log)

df_plm_dem_log <- df_dif_all |> 
  filter(name == "dem_log") |> 
  pdata.frame(index = c("state", "name"), drop.index = FALSE)
pooling_dem_log <- plm(value ~ median_age + males_per_100_females + white_rate +
               personal_income + fy2012 + fy2016 + fy2020, data = df_plm_dem_log,
               model = "pooling")
within_dem_log <- plm(value ~ median_age + males_per_100_females + white_rate +
               personal_income + fy2012 + fy2016 + fy2020, data = df_plm_dem_log,
               model = "within")
random_dem_log <- plm(value ~ median_age + males_per_100_females + white_rate +
               personal_income + fy2012 + fy2016 + fy2020, data = df_plm_dem_log,
               model = "random")
pFtest(within_dem_log, pooling_dem_log)
phtest(within_dem_log, random_dem_log)
```

## å…±å’Œå…šæŠ•ç¥¨æ•°ã®è‡ªç„¶å¯¾æ•°ã‚’ç›®çš„å¤‰æ•°ã¨ã—ãŸå›å¸°åˆ†æ(random)
```{r}
#| echo: true
summary(random_rep_log)
```

## æ°‘ä¸»å…šæŠ•ç¥¨æ•°ã®è‡ªç„¶å¯¾æ•°ã‚’ç›®çš„å¤‰æ•°ã¨ã—ãŸå›å¸°åˆ†æ(random)
```{r}
#| echo: true
summary(random_dem_log)
```

## rep+dem=1ã¨ã—ãŸã¨ãã®dem_rateã‚’ç›®çš„å¤‰æ•°ã¨ã—ãŸå›å¸°åˆ†æ(random)
```{r}
#| echo: true
summary(random_rep_rate_100)
```

```{r}
df_2024_2020 <- map(c("rep_log", "dem_log", "rep_rate_100"), ~{
  df_add |> 
  filter(name == c(.x)) |> 
  filter(year %in% c(2020, 2024)) |> 
  mutate(year = str_c("fy", year)) |> 
  pivot_wider(names_from = year) |> 
  mutate(value = fy2024 - fy2020) |> 
  select(-fy2020, -fy2024)
}) |> list_rbind() |> 
  left_join(df_database, by = "state") |> 
  select(-over_18years_old, -black_rate)

rep_log_2024_2020 <- df_2024_2020 |> 
  filter(name == "rep_log") |> 
  select(-state, -name)
lm_rep_log <- lm(value ~ ., data = rep_log_2024_2020)

dem_log_2024_2020 <- df_2024_2020 |> 
  filter(name == "dem_log") |> 
  select(-state, -name)
lm_dem_log <- lm(value ~ ., data = dem_log_2024_2020)
summary(lm_dem_log)

rep_rate_100_2024_2020 <- df_2024_2020 |> 
  filter(name == "rep_rate_100") |> 
  select(-state, -name)
lm_rep_rate_100 <- lm(value ~ ., data = rep_rate_100_2024_2020)
summary(lm_rep_rate_100)
```

# ãŠã¾ã‘ï¼‰2020â†’2024å¹´ã«èµ·ã“ã£ãŸå¤‰åŒ–ã‚’OLSã§è§£æ

## å…±å’Œå…šæŠ•ç¥¨æ•°ã®è‡ªç„¶å¯¾æ•°ã®å·®ã‚’ç›®çš„å¤‰æ•°ã¨ã—ãŸå›å¸°åˆ†æ(OLS)

$ln(fy2024) - ln(fy2020) = ln(fy2024 / fy2020)$

```{r}
summary(lm_rep_log)
```

## æ°‘ä¸»å…šæŠ•ç¥¨æ•°ã®è‡ªç„¶å¯¾æ•°ã®å·®ã‚’ç›®çš„å¤‰æ•°ã¨ã—ãŸå›å¸°åˆ†æ(OLS)

$ln(fy2024) - ln(fy2020) = ln(fy2024 / fy2020)$

```{r}
summary(lm_dem_log)
```

## rep+dem=1ã¨ã—ãŸã¨ãã®rep_rateã®å·®ã‚’ç›®çš„å¤‰æ•°ã¨ã—ãŸå›å¸°åˆ†æ(OLS)

```{r}
summary(lm_rep_rate_100)
```

## ã¾ã¨ã‚

- æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‘ãƒãƒ«ãƒ‡ãƒ¼ã‚¿ã«ã™ã‚‹ã¨ã€æœ‰æ„å·®ãŒå‡ºã‚„ã™ãã¦ãŠã‚‚ã—ã‚ã„ã‚ˆã€‚
- å ±é“ã‚„SNSã®è«–è©•ã‚’ä¿¡é ¼ã—ã™ããšã€ãƒ‡ãƒ¼ã‚¿ãŒå…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã¯ã€è§£æã—ã¦ã¿ã‚‹ã¨ãŠã‚‚ã—ã‚ã„ã‚ˆã€‚

# Enjoyï¼